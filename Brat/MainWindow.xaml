<Window x:Class="Brat.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        xmlns:local="clr-namespace:Brat"
        PreviewKeyDown="Window_PreviewKeyDown"
        Title="Brat" Height="700" Width="1100" MinHeight="600" MinWidth="900" WindowStartupLocation="CenterScreen"
        FontFamily="pack://application:,,,/Brat;component/Fonts/#SF Pro Rounded"        
        xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit"
        Background="#2D2D2D" Loaded="Window_Loaded" KeyDown="Window_KeyDown" Closing="Window_Closing" Icon="/Avatars/b.ico">
    <Window.Resources>
        <!-- Палитра -->
        <SolidColorBrush x:Key="Col.AppBg"     Color="#2D2D2D"/>
        <SolidColorBrush x:Key="Col.Rail"      Color="#5A5A5A"/>
        <SolidColorBrush x:Key="Col.Side"      Color="#3A3A3A"/>
        <SolidColorBrush x:Key="Col.Top"       Color="#444444"/>
        <SolidColorBrush x:Key="Col.Input"     Color="#444444"/>
        <SolidColorBrush x:Key="Col.BubbleL"   Color="#E6E6E6"/>
        <SolidColorBrush x:Key="Col.BubbleR"   Color="#0078D7"/>

        <!-- Иконка-кнопка (круг) -->
        <Style x:Key="IconButton" TargetType="Button">
            <Setter Property="Width" Value="36"/>
            <Setter Property="Height" Value="36"/>
            <Setter Property="Background" Value="#505050"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="#6A6A6A"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border CornerRadius="18"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Макет одного элемента чата -->
        <!--<DataTemplate x:Key="ChatItemTemplate">
            <Grid Height="52" Margin="-6, 0, 0, 0" Width="301">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="52"/>
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Ellipse Width="42" Height="42" Fill="#D9D9D9" VerticalAlignment="Center" Margin="5,0,0,0"/>
                <StackPanel Grid.Column="1" Margin="5,0,0,0" VerticalAlignment="Center">
                    <StackPanel Height="15" Width="216" HorizontalAlignment="Left">
                        <TextBlock Text="Грант Упизмо" FontSize="14" Foreground="#FFE2E2E2" FontFamily="SF Pro Rounded"/>
                    </StackPanel>
                    <StackPanel Height="15" Width="216" Margin="0, 5, 0, 0" HorizontalAlignment="Left">
                        <TextBlock Text="Иди нахуй" FontSize="14" FontWeight="Normal" Foreground="#FFA4A4A4" FontFamily="SF Pro Rounded"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </DataTemplate>-->

        <!-- Пузырьки -->
        <Style x:Key="BubbleLeft" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource Col.BubbleL}"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Margin" Value="8"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
        </Style>
        <Style x:Key="BubbleRight" TargetType="Border" BasedOn="{StaticResource BubbleLeft}">
            <Setter Property="Background" Value="{StaticResource Col.BubbleR}"/>
            <Setter Property="HorizontalAlignment" Value="Right"/>
        </Style>

        <!-- Убираем выделение у ListBoxItem (скелет-лист) -->
        <Style TargetType="ListBoxItem">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Focusable" Value="False"/>
        </Style>
    </Window.Resources>

    <!-- ===== ГЛАВНАЯ СЕТКА: 3 колонки (рейл / чаты / сообщения) и 3 строки ===== -->
    <Grid>
        <Grid Background="{StaticResource Col.Input}" x:Name="MainGrid">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="64"/>
                <!-- узкий рейл -->
                <ColumnDefinition Width="300"/>
                <!-- список чатов -->
                <ColumnDefinition Width="*"/>
                <!-- область переписки -->
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="57"/>
                <!-- верхняя плашка -->
                <RowDefinition Height="463*"/>
                <!-- контент -->
                <RowDefinition Height="50*" x:Name="RowEnterField" MaxHeight="200"/>
                <!-- нижняя плашка ввода (только для переписки) -->
            </Grid.RowDefinitions>

            <!-- ВЕРХНЯЯ ПАНЕЛЬ — на всю ширину -->
            <Border Grid.Row="0" Grid.Column="2" Background="{DynamicResource Col.Side}" Visibility="Hidden" x:Name="TopRow">
                <Grid Margin="16,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <Button Padding="0" Click="TextBlock_Click" HorizontalAlignment="Left" Width="150" x:Name="ButtonHeader">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="BorderBrush" Value="Transparent"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <TextBlock x:Name="HeaderChatText" Text="Заголовок чата" Foreground="White" VerticalAlignment="Center" FontWeight="Bold" FontSize="14"/>
                                            <ControlTemplate.Triggers>
                                                <!-- Убираем подсветку при наведении -->
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="Transparent"/>
                                                    <Setter Property="BorderBrush" Value="Transparent"/>
                                                    <Setter Property="Cursor" Value="Hand"/>
                                                </Trigger>
                                                <!-- Убираем подсветку при нажатии -->
                                                <Trigger Property="IsPressed" Value="True">
                                                    <Setter Property="Background" Value="Transparent"/>
                                                    <Setter Property="BorderBrush" Value="Transparent"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </Button.Style>
                    </Button>
                    <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                        <Button Style="{StaticResource IconButton}" Content="…"/>
                        <Button Style="{StaticResource IconButton}" Content="≡"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- ЛЕВЫЙ РЕЙЛ -->
            <Grid Grid.RowSpan="3" Grid.Column="0" Background="{StaticResource Col.Rail}" x:Name="LeftRail">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" MinHeight="57"/>
                    <RowDefinition/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Button         Background="Transparent"
                            BorderBrush="Transparent"
                            FocusVisualStyle="{x:Null}" Click="Button_Click">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="BorderBrush" Value="Transparent"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Grid>
                                            <!-- Контент кнопки -->
                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Grid>
                                        <ControlTemplate.Triggers>
                                            <!-- Убираем подсветку при наведении -->
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="Transparent"/>
                                                <Setter Property="BorderBrush" Value="Transparent"/>
                                            </Trigger>
                                            <!-- Убираем подсветку при нажатии -->
                                            <Trigger Property="IsPressed" Value="True">
                                                <Setter Property="Background" Value="Transparent"/>
                                                <Setter Property="BorderBrush" Value="Transparent"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Button.Style>
                    <Grid Background="#FF5A5A5A">
                        <Grid.Style>
                            <Style TargetType="Grid">
                                <Setter Property="Cursor" Value="Arrow"/>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Cursor" Value="Hand"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Grid.Style>
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                            <Button Width="30" Height="30"
                            Background="Transparent"
                            BorderBrush="Transparent"
                            FocusVisualStyle="{x:Null}"
                            Padding="0" HorizontalAlignment="Center" VerticalAlignment="Center" Click="Button_Click">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="BorderBrush" Value="Transparent"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Grid>
                                                        <!-- Контент кнопки -->
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Grid>
                                                    <ControlTemplate.Triggers>
                                                        <!-- Убираем подсветку при наведении -->
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="Transparent"/>
                                                            <Setter Property="BorderBrush" Value="Transparent"/>
                                                        </Trigger>
                                                        <!-- Убираем подсветку при нажатии -->
                                                        <Trigger Property="IsPressed" Value="True">
                                                            <Setter Property="Background" Value="Transparent"/>
                                                            <Setter Property="BorderBrush" Value="Transparent"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </Button.Style>
                                <!-- Иконка гамбургера -->
                                <Viewbox>
                                    <Canvas Width="24" Height="24">
                                        <Path
                                Data="M3 6 H21 M3 12 H21 M3 18 H21"
                                Stroke="{DynamicResource Col.Side}"
                                StrokeThickness="1.5"
                                StrokeStartLineCap="Round"
                                StrokeEndLineCap="Round"/>
                                    </Canvas>
                                </Viewbox>
                            </Button>
                        </StackPanel>
                    </Grid>
                </Button>
                <Button Grid.Row="2" Style="{StaticResource IconButton}" Content="★" Margin="14,12,14,12" Background="#4F4F4F"/>
            </Grid>


            <!-- КОЛОНКА СО СПИСКОМ ЧАТОВ -->
            <Grid Grid.RowSpan="3" Grid.Column="1" Background="{StaticResource Col.Side}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition/>
                </Grid.RowDefinitions>

                <!-- Поиск -->
                <Border Margin="12, 6" Background="#5A5A5A" CornerRadius="20" Height="36" VerticalAlignment="Center">
                    <Grid Margin="12,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <xctk:WatermarkTextBox Grid.ColumnSpan="1" x:Name="SearchTextBox" BorderThickness="0" Background="Transparent" Foreground="White"
                             Padding="10" FontSize="14" Watermark="Поиск" KeyDown="mainTextBox_KeyDown" TextChanged="SearchTextBox_TextChanged">
                            <xctk:WatermarkTextBox.WatermarkTemplate>
                                <DataTemplate>
                                    <TextBlock
                                Text="{Binding}"
                                Foreground="#FFD9D9D9"
                                Opacity="0.6" />
                                </DataTemplate>
                            </xctk:WatermarkTextBox.WatermarkTemplate>
                        </xctk:WatermarkTextBox>
                        <Popup x:Name="SearchPopup" PlacementTarget="{Binding ElementName=SearchTextBox}" 
               Placement="Bottom" StaysOpen="False" AllowsTransparency="True" 
               PopupAnimation="Slide" Width="{Binding ActualWidth, ElementName=SearchTextBox}">
                            <Border Background="#2D2D2D" BorderBrush="#5A5A5A" BorderThickness="1" CornerRadius="6">
                                <ListBox x:Name="SearchResultsList" Background="Transparent" BorderThickness="0"
                         MouseLeftButtonUp="SearchResultsList_MouseLeftButtonUp" SelectionChanged="SearchResultsList_SelectionChanged">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Margin="8" Orientation="Vertical">
                                                <!-- Имя и фамилия -->
                                                <TextBlock FontSize="16" FontWeight="Bold" Foreground="White" >
                                                    <TextBlock.Text>
                                                        <MultiBinding StringFormat="{}{0} {1}">
                                                           <Binding Path="FirstName"/>
                                                            <Binding Path="SecondName"/>
                                                        </MultiBinding>
                                                    </TextBlock.Text>
                                                </TextBlock>                                   
                                                <!-- Username или что-то поменьше -->
                                                <TextBlock Text="{Binding Username}" 
                                   FontSize="12" 
                                   Foreground="#A4A4A4"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </Border>
                        </Popup>
                    </Grid>
                </Border>

                <!-- Макеты элементов чатов -->
                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Hidden">
                    <ListBox x:Name="UsersList" Background="Transparent" BorderThickness="0" SelectionChanged="ListBox_SelectionChanged" HorizontalAlignment="Center" MouseLeftButtonUp="UsersList_MouseLeftButtonUp">
                        <!-- 12 «болванок» -->
                    </ListBox>
                </ScrollViewer>
            </Grid>

            <!-- Разделитель «Непрочитанные сообщения» -->
            <!-- Border Background="#666666" Height="15" Margin="0,12">
            <TextBlock Text="Непрочитанные сообщения" Foreground="White"
                                   FontSize="12" VerticalAlignment="Center" HorizontalAlignment="Center"/></Border-->
            <!-- ОБЛАСТЬ СООБЩЕНИЙ -->
            <Grid Grid.Row="1" Grid.Column="2" Background="{StaticResource Col.Input}">
                <ScrollViewer Padding="10,10" x:Name="chatScroll" VerticalScrollBarVisibility="Hidden" ScrollChanged="chatScroll_ScrollChanged">
                    <StackPanel x:Name="ChatField" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <TextBlock FontSize="20" Text="Выберите, кому вы хотите написать..." Foreground="White" FontFamily="pack://application:,,,/Brat;component/Fonts/#SF Pro Rounded"/>
                    </StackPanel>
                </ScrollViewer>
            </Grid>

            <!-- НИЖНЯЯ ПАНЕЛЬ ВВОДА — только под областью сообщений -->
            <Border Grid.Row="2" Grid.Column="2"
        Background="{DynamicResource Col.Side}"
        BorderThickness="0"
        x:Name="borderEnterField"
        Visibility="Hidden"
        Margin="0,1,0,0"
        Height="Auto">

                <Grid Margin="12,0" x:Name="GridEnterField">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="56"/>
                        <ColumnDefinition Width="79*"/>
                        <ColumnDefinition Width="56"/>
                    </Grid.ColumnDefinitions>
                    <Grid>
                        <Button Content="📎" Click="AttachFile_Click" Grid.Column="0" HorizontalAlignment="Center" VerticalAlignment="Center">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="Transparent"/>
                                    <Setter Property="BorderBrush" Value="Transparent"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Path
                                                    Width="22"
                                                    Height="22"
                                                    Stretch="Uniform"
                                                    Stroke="#C8C8C8"
                                                    StrokeThickness="1.8"
                                                    StrokeStartLineCap="Round"
                                                    StrokeEndLineCap="Round"
                                                    StrokeLineJoin="Round"
                                                    Data="M7.5,13
                                                          L13.7,6.5
                                                          a2.5,2.5 0 1,1 3.5,4.5L10,17.5
                                                          a4,4 0 0,1 -5.5,-5.5L11,5
                                                          a6,6 0 1,1 9.5,8.5L11,22" />

                                                <ControlTemplate.Triggers>
                                                    <!-- Убираем подсветку при наведении -->
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="Transparent"/>
                                                        <Setter Property="BorderBrush" Value="Transparent"/>
                                                        <Setter Property="Cursor" Value="Hand"/>
                                                    </Trigger>
                                                    <!-- Убираем подсветку при нажатии -->
                                                    <Trigger Property="IsPressed" Value="True">
                                                        <Setter Property="Background" Value="Transparent"/>
                                                        <Setter Property="BorderBrush" Value="Transparent"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </Button.Style>
                        </Button>
                    </Grid>
                    <!-- Обёртка с закруглениями -->
                    <Border Background="#FF3A3A3A"
                CornerRadius="8"
                MinHeight="40"
                MaxHeight="200"
                VerticalAlignment="Center"
                Margin="0,0,8,0" Grid.Column="1" Height="40">

                        <xctk:WatermarkTextBox x:Name="mainTextBox"
                                   BorderThickness="0"
                                   Background="Transparent"
                                   Foreground="White"
                                   Padding="12,10"
                                   FontSize="14"
                                   TextWrapping="Wrap"
                                   AcceptsReturn="True"
                                   Watermark="Сообщение..."
                                   TextChanged="mainTextBox_TextChanged"
                                   VerticalAlignment="Bottom"
                                   MinHeight="40" PreviewKeyDown="mainTextBox_PreviewKeyDown"/>
                    </Border>

                    <!-- Кнопка отправки -->

                    <Button x:Name="SendMessage"
                Grid.Column="2"
                            Content="🎤"
                FontSize="24"
                FontWeight="Bold"
                Background="#5A5A5A"
                Foreground="White"
                BorderThickness="0"
                Width="56"
                Height="40"
                VerticalAlignment="Center"
                Click="SendMessage_Click" HorizontalAlignment="Center" PreviewMouseLeftButtonDown="SendMessage_MouseDown" PreviewMouseLeftButtonUp="SendMessage_MouseUp">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="BorderBrush" Value="Transparent"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Grid Background="Transparent">
                                                <!-- Контент кнопки -->
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                <Viewbox Width="25" Height="25">

                                                </Viewbox>

                                            </Grid>
                                            <ControlTemplate.Triggers>
                                                <!-- Убираем подсветку при наведении -->
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="Transparent"/>
                                                    <Setter Property="BorderBrush" Value="Transparent"/>
                                                    <Setter Property="Cursor" Value="Hand"/>
                                                </Trigger>
                                                <!-- Убираем подсветку при нажатии -->
                                                <Trigger Property="IsPressed" Value="True">
                                                    <Setter Property="Background" Value="Transparent"/>
                                                    <Setter Property="BorderBrush" Value="Transparent"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </Button.Style>
                    </Button>
                </Grid>
            </Border>

        </Grid>
        <Rectangle Fill="#33000000" x:Name="DimLayer" Visibility="Hidden" MouseDown="DimLayer_MouseDown"/>
    </Grid>
</Window>
